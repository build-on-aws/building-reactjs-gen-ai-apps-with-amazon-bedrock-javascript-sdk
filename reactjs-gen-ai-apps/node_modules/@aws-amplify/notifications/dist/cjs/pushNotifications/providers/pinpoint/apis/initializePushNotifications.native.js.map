{"version":3,"file":"initializePushNotifications.native.js","sources":["../../../../../../src/pushNotifications/providers/pinpoint/apis/initializePushNotifications.native.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.initializePushNotifications = void 0;\nconst core_1 = require(\"@aws-amplify/core\");\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst pinpoint_1 = require(\"@aws-amplify/core/internals/providers/pinpoint\");\nconst react_native_1 = require(\"@aws-amplify/react-native\");\nconst eventListeners_1 = require(\"../../../../eventListeners\");\nconst utils_2 = require(\"../../../utils\");\nconst utils_3 = require(\"../utils\");\nconst { addMessageEventListener, addTokenEventListener, completeNotification, getConstants, registerHeadlessTask, } = (0, react_native_1.loadAmplifyPushNotification)();\nconst logger = new core_1.ConsoleLogger('Notifications.PushNotification');\nconst BACKGROUND_TASK_TIMEOUT = 25; // seconds\nconst initializePushNotifications = () => {\n    if ((0, utils_2.isInitialized)()) {\n        logger.info('Push notifications have already been enabled');\n        return;\n    }\n    addNativeListeners();\n    addAnalyticsListeners();\n    (0, utils_2.initialize)();\n};\nexports.initializePushNotifications = initializePushNotifications;\nconst addNativeListeners = () => {\n    let launchNotificationOpenedListener;\n    const { NativeEvent, NativeHeadlessTaskKey } = getConstants();\n    const { BACKGROUND_MESSAGE_RECEIVED, FOREGROUND_MESSAGE_RECEIVED, LAUNCH_NOTIFICATION_OPENED, NOTIFICATION_OPENED, TOKEN_RECEIVED, } = NativeEvent;\n    // on platforms that can handle headless tasks, register one to broadcast background message received to\n    // library listeners\n    if (NativeHeadlessTaskKey) {\n        registerHeadlessTask(async (message) => {\n            // keep headless task running until handlers have completed their work\n            await (0, eventListeners_1.notifyEventListenersAndAwaitHandlers)('backgroundMessageReceived', message);\n        });\n    }\n    else if (BACKGROUND_MESSAGE_RECEIVED) {\n        // on platforms that can't handle headless tasks, listen for native background message received event and\n        // broadcast to library listeners\n        addMessageEventListener(BACKGROUND_MESSAGE_RECEIVED, async (message, completionHandlerId) => {\n            // keep background task running until handlers have completed their work\n            try {\n                await Promise.race([\n                    (0, eventListeners_1.notifyEventListenersAndAwaitHandlers)('backgroundMessageReceived', message),\n                    // background tasks will get suspended and all future tasks be deprioritized by the OS if they run for\n                    // more than 30 seconds so we reject with a error in a shorter amount of time to prevent this from\n                    // happening\n                    new Promise((_, reject) => {\n                        setTimeout(() => reject(`onNotificationReceivedInBackground handlers should complete their work within ${BACKGROUND_TASK_TIMEOUT} seconds, but they did not.`), BACKGROUND_TASK_TIMEOUT * 1000);\n                    }),\n                ]);\n            }\n            catch (err) {\n                logger.error(err);\n            }\n            finally {\n                // notify native module that handlers have completed their work (or timed out)\n                if (completionHandlerId) {\n                    completeNotification(completionHandlerId);\n                }\n            }\n        });\n    }\n    addMessageEventListener(\n    // listen for native foreground message received event and broadcast to library listeners\n    FOREGROUND_MESSAGE_RECEIVED, message => {\n        (0, eventListeners_1.notifyEventListeners)('foregroundMessageReceived', message);\n    });\n    launchNotificationOpenedListener = LAUNCH_NOTIFICATION_OPENED\n        ? addMessageEventListener(\n        // listen for native notification opened app (user tapped on notification, opening the app from quit -\n        // not background - state) event. This is broadcasted to an internal listener only as it is not intended\n        // for use otherwise as it produces inconsistent results when used within React Native app context\n        LAUNCH_NOTIFICATION_OPENED, message => {\n            (0, eventListeners_1.notifyEventListeners)('launchNotificationOpened', message);\n            // once we are done with it we can remove the listener\n            launchNotificationOpenedListener?.remove();\n        })\n        : null;\n    addMessageEventListener(\n    // listen for native notification opened (user tapped on notification, opening the app from background -\n    // not quit - state) event and broadcast to library listeners\n    NOTIFICATION_OPENED, message => {\n        (0, eventListeners_1.notifyEventListeners)('notificationOpened', message);\n        // if we are in this state, we no longer need the listener as the app was launched via some other means\n        launchNotificationOpenedListener?.remove();\n    });\n    addTokenEventListener(\n    // listen for native new token event, automatically re-register device with provider using new token and\n    // broadcast to library listeners\n    TOKEN_RECEIVED, async (token) => {\n        // avoid a race condition where two endpoints are created with the same token on a fresh install\n        if ((0, utils_2.getToken)() === token) {\n            return;\n        }\n        (0, utils_2.setToken)(token);\n        (0, eventListeners_1.notifyEventListeners)('tokenReceived', token);\n        try {\n            await registerDevice(token);\n        }\n        catch (err) {\n            logger.error('Failed to register device for push notifications', err);\n            throw err;\n        }\n    });\n};\nconst addAnalyticsListeners = () => {\n    let launchNotificationOpenedListenerRemover;\n    // wire up default Pinpoint message event handling\n    (0, eventListeners_1.addEventListener)('backgroundMessageReceived', (0, utils_3.createMessageEventRecorder)('received_background'));\n    (0, eventListeners_1.addEventListener)('foregroundMessageReceived', (0, utils_3.createMessageEventRecorder)('received_foreground'));\n    launchNotificationOpenedListenerRemover = (0, eventListeners_1.addEventListener)('launchNotificationOpened', (0, utils_3.createMessageEventRecorder)('opened_notification', \n    // once we are done with it we can remove the listener\n    launchNotificationOpenedListenerRemover?.remove));\n    (0, eventListeners_1.addEventListener)('notificationOpened', (0, utils_3.createMessageEventRecorder)('opened_notification', \n    // if we are in this state, we no longer need the listener as the app was launched via some other means\n    launchNotificationOpenedListenerRemover?.remove));\n};\nconst registerDevice = async (address) => {\n    const { credentials, identityId } = await (0, utils_2.resolveCredentials)();\n    const { appId, region } = (0, utils_3.resolveConfig)();\n    await (0, pinpoint_1.updateEndpoint)({\n        address,\n        appId,\n        category: 'PushNotification',\n        credentials,\n        region,\n        channelType: (0, utils_3.getChannelType)(),\n        identityId,\n        userAgentValue: (0, utils_2.getPushNotificationUserAgentString)(utils_1.PushNotificationAction.InitializePushNotifications),\n    });\n};\n"],"names":[],"mappings":"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"}