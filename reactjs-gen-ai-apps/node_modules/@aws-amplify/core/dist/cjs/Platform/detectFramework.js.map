{"version":3,"file":"detectFramework.js","sources":["../../../src/Platform/detectFramework.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.clearCache = exports.observeFrameworkChanges = exports.detectFramework = exports.frameworkChangeObservers = void 0;\nconst types_1 = require(\"./types\");\nconst detection_1 = require(\"./detection\");\n// We want to cache detection since the framework won't change\nlet frameworkCache;\nexports.frameworkChangeObservers = [];\n// Setup the detection reset tracking / timeout delays\nlet resetTriggered = false;\nconst SSR_RESET_TIMEOUT = 10; // ms\nconst WEB_RESET_TIMEOUT = 10; // ms\nconst PRIME_FRAMEWORK_DELAY = 1000; // ms\nconst detectFramework = () => {\n    if (!frameworkCache) {\n        frameworkCache = (0, detection_1.detect)();\n        if (resetTriggered) {\n            // The final run of detectFramework:\n            // Starting from this point, the `frameworkCache` becomes \"final\".\n            // So we don't need to notify the observers again so the observer\n            // can be removed after the final notice.\n            while (exports.frameworkChangeObservers.length) {\n                exports.frameworkChangeObservers.pop()?.();\n            }\n        }\n        else {\n            // The first run of detectFramework:\n            // Every time we update the cache, call each observer function\n            exports.frameworkChangeObservers.forEach(fcn => fcn());\n        }\n        // Retry once for either Unknown type after a delay (explained below)\n        resetTimeout(types_1.Framework.ServerSideUnknown, SSR_RESET_TIMEOUT);\n        resetTimeout(types_1.Framework.WebUnknown, WEB_RESET_TIMEOUT);\n    }\n    return frameworkCache;\n};\nexports.detectFramework = detectFramework;\n/**\n * @internal Setup observer callback that will be called everytime the framework changes\n */\nconst observeFrameworkChanges = (fcn) => {\n    // When the `frameworkCache` won't be updated again, we ignore all incoming\n    // observers.\n    if (resetTriggered) {\n        return;\n    }\n    exports.frameworkChangeObservers.push(fcn);\n};\nexports.observeFrameworkChanges = observeFrameworkChanges;\nfunction clearCache() {\n    frameworkCache = undefined;\n}\nexports.clearCache = clearCache;\n// For a framework type and a delay amount, setup the event to re-detect\n//   During the runtime boot, it is possible that framework detection will\n//   be triggered before the framework has made modifications to the\n//   global/window/etc needed for detection. When no framework is detected\n//   we will reset and try again to ensure we don't use a cached\n//   non-framework detection result for all requests.\nfunction resetTimeout(framework, delay) {\n    if (frameworkCache === framework && !resetTriggered) {\n        setTimeout(() => {\n            clearCache();\n            resetTriggered = true;\n            setTimeout(exports.detectFramework, PRIME_FRAMEWORK_DELAY);\n        }, delay);\n    }\n}\n"],"names":[],"mappings":";;AACA;AACA;AACA,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,YAAY,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;AAC9D,OAAO,CAAC,UAAU,GAAG,OAAO,CAAC,uBAAuB,GAAG,OAAO,CAAC,eAAe,GAAG,OAAO,CAAC,wBAAwB,GAAG,KAAK,CAAC,CAAC;AAC3H,MAAM,OAAO,GAAG,OAAO,CAAC,SAAS,CAAC,CAAC;AACnC,MAAM,WAAW,GAAG,OAAO,CAAC,aAAa,CAAC,CAAC;AAC3C;AACA,IAAI,cAAc,CAAC;AACnB,OAAO,CAAC,wBAAwB,GAAG,EAAE,CAAC;AACtC;AACA,IAAI,cAAc,GAAG,KAAK,CAAC;AAC3B,MAAM,iBAAiB,GAAG,EAAE,CAAC;AAC7B,MAAM,iBAAiB,GAAG,EAAE,CAAC;AAC7B,MAAM,qBAAqB,GAAG,IAAI,CAAC;AACnC,MAAM,eAAe,GAAG,MAAM;AAC9B,IAAI,IAAI,CAAC,cAAc,EAAE;AACzB,QAAQ,cAAc,GAAG,IAAI,WAAW,CAAC,MAAM,GAAG,CAAC;AACnD,QAAQ,IAAI,cAAc,EAAE;AAC5B;AACA;AACA;AACA;AACA,YAAY,OAAO,OAAO,CAAC,wBAAwB,CAAC,MAAM,EAAE;AAC5D,gBAAgB,OAAO,CAAC,wBAAwB,CAAC,GAAG,EAAE,IAAI,CAAC;AAC3D,aAAa;AACb,SAAS;AACT,aAAa;AACb;AACA;AACA,YAAY,OAAO,CAAC,wBAAwB,CAAC,OAAO,CAAC,GAAG,IAAI,GAAG,EAAE,CAAC,CAAC;AACnE,SAAS;AACT;AACA,QAAQ,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,iBAAiB,EAAE,iBAAiB,CAAC,CAAC;AAC7E,QAAQ,YAAY,CAAC,OAAO,CAAC,SAAS,CAAC,UAAU,EAAE,iBAAiB,CAAC,CAAC;AACtE,KAAK;AACL,IAAI,OAAO,cAAc,CAAC;AAC1B,CAAC,CAAC;AACF,OAAO,CAAC,eAAe,GAAG,eAAe,CAAC;AAC1C;AACA;AACA;AACA,MAAM,uBAAuB,GAAG,CAAC,GAAG,KAAK;AACzC;AACA;AACA,IAAI,IAAI,cAAc,EAAE;AACxB,QAAQ,OAAO;AACf,KAAK;AACL,IAAI,OAAO,CAAC,wBAAwB,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AAC/C,CAAC,CAAC;AACF,OAAO,CAAC,uBAAuB,GAAG,uBAAuB,CAAC;AAC1D,SAAS,UAAU,GAAG;AACtB,IAAI,cAAc,GAAG,SAAS,CAAC;AAC/B,CAAC;AACD,OAAO,CAAC,UAAU,GAAG,UAAU,CAAC;AAChC;AACA;AACA;AACA;AACA;AACA;AACA,SAAS,YAAY,CAAC,SAAS,EAAE,KAAK,EAAE;AACxC,IAAI,IAAI,cAAc,KAAK,SAAS,IAAI,CAAC,cAAc,EAAE;AACzD,QAAQ,UAAU,CAAC,MAAM;AACzB,YAAY,UAAU,EAAE,CAAC;AACzB,YAAY,cAAc,GAAG,IAAI,CAAC;AAClC,YAAY,UAAU,CAAC,OAAO,CAAC,eAAe,EAAE,qBAAqB,CAAC,CAAC;AACvE,SAAS,EAAE,KAAK,CAAC,CAAC;AAClB,KAAK;AACL;;"}