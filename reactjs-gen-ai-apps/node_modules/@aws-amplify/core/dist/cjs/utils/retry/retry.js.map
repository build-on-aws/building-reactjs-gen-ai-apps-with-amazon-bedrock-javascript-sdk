{"version":3,"file":"retry.js","sources":["../../../../src/utils/retry/retry.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.retry = void 0;\nconst ConsoleLogger_1 = require(\"../../Logger/ConsoleLogger\");\nconst isNonRetryableError_1 = require(\"./isNonRetryableError\");\nconst logger = new ConsoleLogger_1.ConsoleLogger('retryUtil');\n/**\n * @private\n * Internal use of Amplify only\n */\nasync function retry(functionToRetry, args, delayFn, onTerminate) {\n    if (typeof functionToRetry !== 'function') {\n        throw Error('functionToRetry must be a function');\n    }\n    return new Promise(async (resolve, reject) => {\n        let attempt = 0;\n        let terminated = false;\n        let timeout;\n        let wakeUp = () => { }; // will be replaced with a resolver()\n        // used after the loop if terminated while waiting for a timer.\n        let lastError;\n        onTerminate &&\n            onTerminate.then(() => {\n                // signal not to try anymore.\n                terminated = true;\n                // stop sleeping if we're sleeping.\n                clearTimeout(timeout);\n                wakeUp();\n            });\n        while (!terminated) {\n            attempt++;\n            logger.debug(`${functionToRetry.name} attempt #${attempt} with this vars: ${JSON.stringify(args)}`);\n            try {\n                return resolve(await functionToRetry(...args));\n            }\n            catch (err) {\n                lastError = err;\n                logger.debug(`error on ${functionToRetry.name}`, err);\n                if ((0, isNonRetryableError_1.isNonRetryableError)(err)) {\n                    logger.debug(`${functionToRetry.name} non retryable error`, err);\n                    return reject(err);\n                }\n                const retryIn = delayFn(attempt, args, err);\n                logger.debug(`${functionToRetry.name} retrying in ${retryIn} ms`);\n                // we check `terminated` again here because it could have flipped\n                // in the time it took `functionToRetry` to return.\n                if (retryIn === false || terminated) {\n                    return reject(err);\n                }\n                else {\n                    await new Promise(r => {\n                        wakeUp = r; // export wakeUp for onTerminate handling\n                        timeout = setTimeout(wakeUp, retryIn);\n                    });\n                }\n            }\n        }\n        // reached if terminated while waiting for a timer.\n        reject(lastError);\n    });\n}\nexports.retry = retry;\n"],"names":[],"mappings":"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"}