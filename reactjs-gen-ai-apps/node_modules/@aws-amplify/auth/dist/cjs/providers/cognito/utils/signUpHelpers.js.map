{"version":3,"file":"signUpHelpers.js","sources":["../../../../../src/providers/cognito/utils/signUpHelpers.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.autoSignInUserConfirmed = exports.autoSignInWhenUserIsConfirmedWithLink = exports.isSignUpComplete = exports.setAutoSignInStarted = exports.isAutoSignInStarted = exports.isAutoSignInUserUsingConfirmSignUp = exports.setUsernameUsedForAutoSignIn = exports.handleCodeAutoSignIn = void 0;\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst signIn_1 = require(\"../apis/signIn\");\nconst AuthError_1 = require(\"../../../errors/AuthError\");\nconst autoSignIn_1 = require(\"../apis/autoSignIn\");\nconst constants_1 = require(\"../../../errors/constants\");\nconst MAX_AUTOSIGNIN_POLLING_MS = 3 * 60 * 1000;\nfunction handleCodeAutoSignIn(signInInput) {\n    const stopHubListener = utils_1.HubInternal.listen('auth-internal', async ({ payload }) => {\n        switch (payload.event) {\n            case 'confirmSignUp': {\n                const response = payload.data;\n                if (response?.isSignUpComplete) {\n                    utils_1.HubInternal.dispatch('auth-internal', {\n                        event: 'autoSignIn',\n                    });\n                    (0, autoSignIn_1.setAutoSignIn)(autoSignInWithCode(signInInput));\n                    stopHubListener();\n                }\n            }\n        }\n    });\n    // This will stop the listener if confirmSignUp is not resolved.\n    const timeOutId = setTimeout(() => {\n        stopHubListener();\n        setAutoSignInStarted(false);\n        clearTimeout(timeOutId);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }, MAX_AUTOSIGNIN_POLLING_MS);\n}\nexports.handleCodeAutoSignIn = handleCodeAutoSignIn;\nfunction debounce(fun, delay) {\n    let timer;\n    return function (args) {\n        if (!timer) {\n            fun(...args);\n        }\n        clearTimeout(timer);\n        timer = setTimeout(() => {\n            timer = undefined;\n        }, delay);\n    };\n}\nfunction handleAutoSignInWithLink(signInInput, resolve, reject) {\n    const start = Date.now();\n    const autoSignInPollingIntervalId = setInterval(async () => {\n        const elapsedTime = Date.now() - start;\n        const maxTime = MAX_AUTOSIGNIN_POLLING_MS;\n        if (elapsedTime > maxTime) {\n            clearInterval(autoSignInPollingIntervalId);\n            setAutoSignInStarted(false);\n            reject(new AuthError_1.AuthError({\n                name: constants_1.AUTO_SIGN_IN_EXCEPTION,\n                message: 'The account was not confirmed on time.',\n                recoverySuggestion: 'Try to verify your account by clicking the link sent your email or phone and then login manually.',\n            }));\n            (0, autoSignIn_1.resetAutoSignIn)();\n            return;\n        }\n        else {\n            try {\n                const signInOutput = await (0, signIn_1.signIn)(signInInput);\n                if (signInOutput.nextStep.signInStep !== 'CONFIRM_SIGN_UP') {\n                    resolve(signInOutput);\n                    clearInterval(autoSignInPollingIntervalId);\n                    setAutoSignInStarted(false);\n                    (0, autoSignIn_1.resetAutoSignIn)();\n                    return;\n                }\n            }\n            catch (error) {\n                clearInterval(autoSignInPollingIntervalId);\n                setAutoSignInStarted(false);\n                reject(error);\n                (0, autoSignIn_1.resetAutoSignIn)();\n            }\n        }\n    }, 5000);\n}\nconst debouncedAutoSignInWithLink = debounce(handleAutoSignInWithLink, 300);\nconst debouncedAutoSignWithCodeOrUserConfirmed = debounce(handleAutoSignInWithCodeOrUserConfirmed, 300);\nlet autoSignInStarted = false;\nlet usernameUsedForAutoSignIn;\nfunction setUsernameUsedForAutoSignIn(username) {\n    usernameUsedForAutoSignIn = username;\n}\nexports.setUsernameUsedForAutoSignIn = setUsernameUsedForAutoSignIn;\nfunction isAutoSignInUserUsingConfirmSignUp(username) {\n    return usernameUsedForAutoSignIn === username;\n}\nexports.isAutoSignInUserUsingConfirmSignUp = isAutoSignInUserUsingConfirmSignUp;\nfunction isAutoSignInStarted() {\n    return autoSignInStarted;\n}\nexports.isAutoSignInStarted = isAutoSignInStarted;\nfunction setAutoSignInStarted(value) {\n    if (value === false) {\n        setUsernameUsedForAutoSignIn(undefined);\n    }\n    autoSignInStarted = value;\n}\nexports.setAutoSignInStarted = setAutoSignInStarted;\nfunction isSignUpComplete(output) {\n    return !!output.UserConfirmed;\n}\nexports.isSignUpComplete = isSignUpComplete;\nfunction autoSignInWhenUserIsConfirmedWithLink(signInInput) {\n    return async () => {\n        return new Promise(async (resolve, reject) => {\n            debouncedAutoSignInWithLink([signInInput, resolve, reject]);\n        });\n    };\n}\nexports.autoSignInWhenUserIsConfirmedWithLink = autoSignInWhenUserIsConfirmedWithLink;\nasync function handleAutoSignInWithCodeOrUserConfirmed(signInInput, resolve, reject) {\n    try {\n        const output = await (0, signIn_1.signIn)(signInInput);\n        resolve(output);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }\n    catch (error) {\n        reject(error);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }\n}\nfunction autoSignInWithCode(signInInput) {\n    return async () => {\n        return new Promise(async (resolve, reject) => {\n            debouncedAutoSignWithCodeOrUserConfirmed([signInInput, resolve, reject]);\n        });\n    };\n}\nexports.autoSignInUserConfirmed = autoSignInWithCode;\n"],"names":[],"mappings":"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"}