{"version":3,"file":"attemptCompleteOAuthFlow.js","sources":["../../../../../../src/providers/cognito/utils/oauth/attemptCompleteOAuthFlow.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.attemptCompleteOAuthFlow = void 0;\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst oAuthStore_1 = require(\"./oAuthStore\");\nconst completeOAuthFlow_1 = require(\"./completeOAuthFlow\");\nconst utils_2 = require(\"../../../../utils\");\nconst getRedirectUrl_1 = require(\"./getRedirectUrl\");\nconst handleFailure_1 = require(\"./handleFailure\");\nconst tokenProvider_1 = require(\"../../tokenProvider\");\nconst inflightPromise_1 = require(\"./inflightPromise\");\nconst attemptCompleteOAuthFlow = async (authConfig) => {\n    try {\n        (0, utils_1.assertTokenProviderConfig)(authConfig);\n        (0, utils_1.assertOAuthConfig)(authConfig);\n        oAuthStore_1.oAuthStore.setAuthConfig(authConfig);\n    }\n    catch (_) {\n        // no-op\n        // This should not happen as Amplify singleton checks the oauth config key\n        // unless the oauth config object doesn't contain required properties\n        return;\n    }\n    // No inflight OAuth\n    if (!(await oAuthStore_1.oAuthStore.loadOAuthInFlight())) {\n        return;\n    }\n    // when there is valid oauth config and there is an inflight oauth flow, try\n    // to block async calls that require fetching tokens before the oauth flow completes\n    // e.g. getCurrentUser, fetchAuthSession etc.\n    const asyncGetSessionBlocker = new Promise((resolve, _) => {\n        (0, inflightPromise_1.addInflightPromise)(resolve);\n    });\n    tokenProvider_1.cognitoUserPoolsTokenProvider.setWaitForInflightOAuth(() => asyncGetSessionBlocker);\n    try {\n        const currentUrl = window.location.href;\n        const { loginWith, userPoolClientId } = authConfig;\n        const { domain, redirectSignIn, responseType } = loginWith.oauth;\n        const redirectUri = (0, getRedirectUrl_1.getRedirectUrl)(redirectSignIn);\n        await (0, completeOAuthFlow_1.completeOAuthFlow)({\n            currentUrl,\n            clientId: userPoolClientId,\n            domain,\n            redirectUri,\n            responseType,\n            userAgentValue: (0, utils_2.getAuthUserAgentValue)(utils_1.AuthAction.SignInWithRedirect),\n        });\n    }\n    catch (err) {\n        await (0, handleFailure_1.handleFailure)(err);\n    }\n};\nexports.attemptCompleteOAuthFlow = attemptCompleteOAuthFlow;\n"],"names":[],"mappings":";;AACA;AACA;AACA,MAAM,CAAC,cAAc,CAAC,OAAO,EAAE,YAAY,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,CAAC,CAAC;AAC9D,OAAO,CAAC,wBAAwB,GAAG,KAAK,CAAC,CAAC;AAC1C,MAAM,OAAO,GAAG,OAAO,CAAC,mCAAmC,CAAC,CAAC;AAC7D,MAAM,YAAY,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;AAC7C,MAAM,mBAAmB,GAAG,OAAO,CAAC,qBAAqB,CAAC,CAAC;AAC3D,MAAM,OAAO,GAAG,OAAO,CAAC,mBAAmB,CAAC,CAAC;AAC7C,MAAM,gBAAgB,GAAG,OAAO,CAAC,kBAAkB,CAAC,CAAC;AACrD,MAAM,eAAe,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC;AACnD,MAAM,eAAe,GAAG,OAAO,CAAC,qBAAqB,CAAC,CAAC;AACvD,MAAM,iBAAiB,GAAG,OAAO,CAAC,mBAAmB,CAAC,CAAC;AACvD,MAAM,wBAAwB,GAAG,OAAO,UAAU,KAAK;AACvD,IAAI,IAAI;AACR,QAAQ,CAAC,CAAC,EAAE,OAAO,CAAC,yBAAyB,EAAE,UAAU,CAAC,CAAC;AAC3D,QAAQ,CAAC,CAAC,EAAE,OAAO,CAAC,iBAAiB,EAAE,UAAU,CAAC,CAAC;AACnD,QAAQ,YAAY,CAAC,UAAU,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;AAC1D,KAAK;AACL,IAAI,OAAO,CAAC,EAAE;AACd;AACA;AACA;AACA,QAAQ,OAAO;AACf,KAAK;AACL;AACA,IAAI,IAAI,EAAE,MAAM,YAAY,CAAC,UAAU,CAAC,iBAAiB,EAAE,CAAC,EAAE;AAC9D,QAAQ,OAAO;AACf,KAAK;AACL;AACA;AACA;AACA,IAAI,MAAM,sBAAsB,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,CAAC,KAAK;AAC/D,QAAQ,IAAI,iBAAiB,CAAC,kBAAkB,EAAE,OAAO,CAAC,CAAC;AAC3D,KAAK,CAAC,CAAC;AACP,IAAI,eAAe,CAAC,6BAA6B,CAAC,uBAAuB,CAAC,MAAM,sBAAsB,CAAC,CAAC;AACxG,IAAI,IAAI;AACR,QAAQ,MAAM,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC;AAChD,QAAQ,MAAM,EAAE,SAAS,EAAE,gBAAgB,EAAE,GAAG,UAAU,CAAC;AAC3D,QAAQ,MAAM,EAAE,MAAM,EAAE,cAAc,EAAE,YAAY,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC;AACzE,QAAQ,MAAM,WAAW,GAAG,CAAC,CAAC,EAAE,gBAAgB,CAAC,cAAc,EAAE,cAAc,CAAC,CAAC;AACjF,QAAQ,MAAM,CAAC,CAAC,EAAE,mBAAmB,CAAC,iBAAiB,EAAE;AACzD,YAAY,UAAU;AACtB,YAAY,QAAQ,EAAE,gBAAgB;AACtC,YAAY,MAAM;AAClB,YAAY,WAAW;AACvB,YAAY,YAAY;AACxB,YAAY,cAAc,EAAE,CAAC,CAAC,EAAE,OAAO,CAAC,qBAAqB,EAAE,OAAO,CAAC,UAAU,CAAC,kBAAkB,CAAC;AACrG,SAAS,CAAC,CAAC;AACX,KAAK;AACL,IAAI,OAAO,GAAG,EAAE;AAChB,QAAQ,MAAM,IAAI,eAAe,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC;AACtD,KAAK;AACL,CAAC,CAAC;AACF,OAAO,CAAC,wBAAwB,GAAG,wBAAwB;;"}