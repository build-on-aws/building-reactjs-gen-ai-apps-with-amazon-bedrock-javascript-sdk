{"version":3,"file":"attemptCompleteOAuthFlow.mjs","sources":["../../../../../../src/providers/cognito/utils/oauth/attemptCompleteOAuthFlow.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { AuthAction, assertOAuthConfig, assertTokenProviderConfig, } from '@aws-amplify/core/internals/utils';\nimport { oAuthStore } from './oAuthStore';\nimport { completeOAuthFlow } from './completeOAuthFlow';\nimport { getAuthUserAgentValue } from '../../../../utils';\nimport { getRedirectUrl } from './getRedirectUrl';\nimport { handleFailure } from './handleFailure';\nimport { cognitoUserPoolsTokenProvider } from '../../tokenProvider';\nimport { addInflightPromise } from './inflightPromise';\nexport const attemptCompleteOAuthFlow = async (authConfig) => {\n    try {\n        assertTokenProviderConfig(authConfig);\n        assertOAuthConfig(authConfig);\n        oAuthStore.setAuthConfig(authConfig);\n    }\n    catch (_) {\n        // no-op\n        // This should not happen as Amplify singleton checks the oauth config key\n        // unless the oauth config object doesn't contain required properties\n        return;\n    }\n    // No inflight OAuth\n    if (!(await oAuthStore.loadOAuthInFlight())) {\n        return;\n    }\n    // when there is valid oauth config and there is an inflight oauth flow, try\n    // to block async calls that require fetching tokens before the oauth flow completes\n    // e.g. getCurrentUser, fetchAuthSession etc.\n    const asyncGetSessionBlocker = new Promise((resolve, _) => {\n        addInflightPromise(resolve);\n    });\n    cognitoUserPoolsTokenProvider.setWaitForInflightOAuth(() => asyncGetSessionBlocker);\n    try {\n        const currentUrl = window.location.href;\n        const { loginWith, userPoolClientId } = authConfig;\n        const { domain, redirectSignIn, responseType } = loginWith.oauth;\n        const redirectUri = getRedirectUrl(redirectSignIn);\n        await completeOAuthFlow({\n            currentUrl,\n            clientId: userPoolClientId,\n            domain,\n            redirectUri,\n            responseType,\n            userAgentValue: getAuthUserAgentValue(AuthAction.SignInWithRedirect),\n        });\n    }\n    catch (err) {\n        await handleFailure(err);\n    }\n};\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AASY,MAAC,wBAAwB,GAAG,OAAO,UAAU,KAAK;AAC9D,IAAI,IAAI;AACR,QAAQ,yBAAyB,CAAC,UAAU,CAAC,CAAC;AAC9C,QAAQ,iBAAiB,CAAC,UAAU,CAAC,CAAC;AACtC,QAAQ,UAAU,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;AAC7C,KAAK;AACL,IAAI,OAAO,CAAC,EAAE;AACd;AACA;AACA;AACA,QAAQ,OAAO;AACf,KAAK;AACL;AACA,IAAI,IAAI,EAAE,MAAM,UAAU,CAAC,iBAAiB,EAAE,CAAC,EAAE;AACjD,QAAQ,OAAO;AACf,KAAK;AACL;AACA;AACA;AACA,IAAI,MAAM,sBAAsB,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,CAAC,KAAK;AAC/D,QAAQ,kBAAkB,CAAC,OAAO,CAAC,CAAC;AACpC,KAAK,CAAC,CAAC;AACP,IAAI,6BAA6B,CAAC,uBAAuB,CAAC,MAAM,sBAAsB,CAAC,CAAC;AACxF,IAAI,IAAI;AACR,QAAQ,MAAM,UAAU,GAAG,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC;AAChD,QAAQ,MAAM,EAAE,SAAS,EAAE,gBAAgB,EAAE,GAAG,UAAU,CAAC;AAC3D,QAAQ,MAAM,EAAE,MAAM,EAAE,cAAc,EAAE,YAAY,EAAE,GAAG,SAAS,CAAC,KAAK,CAAC;AACzE,QAAQ,MAAM,WAAW,GAAG,cAAc,CAAC,cAAc,CAAC,CAAC;AAC3D,QAAQ,MAAM,iBAAiB,CAAC;AAChC,YAAY,UAAU;AACtB,YAAY,QAAQ,EAAE,gBAAgB;AACtC,YAAY,MAAM;AAClB,YAAY,WAAW;AACvB,YAAY,YAAY;AACxB,YAAY,cAAc,EAAE,qBAAqB,CAAC,UAAU,CAAC,kBAAkB,CAAC;AAChF,SAAS,CAAC,CAAC;AACX,KAAK;AACL,IAAI,OAAO,GAAG,EAAE;AAChB,QAAQ,MAAM,aAAa,CAAC,GAAG,CAAC,CAAC;AACjC,KAAK;AACL;;;;"}