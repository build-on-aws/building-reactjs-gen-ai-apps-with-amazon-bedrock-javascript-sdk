{"version":3,"file":"autoTrackMedia.mjs","sources":["../../../../../src/providers/personalize/utils/autoTrackMedia.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { isBrowser } from '@aws-amplify/core/internals/utils';\nimport { ConsoleLogger } from '@aws-amplify/core';\nvar HTML5_MEDIA_EVENT;\n(function (HTML5_MEDIA_EVENT) {\n    HTML5_MEDIA_EVENT[\"PLAY\"] = \"play\";\n    HTML5_MEDIA_EVENT[\"PAUSE\"] = \"pause\";\n    HTML5_MEDIA_EVENT[\"ENDED\"] = \"Ended\";\n})(HTML5_MEDIA_EVENT || (HTML5_MEDIA_EVENT = {}));\nvar MEDIA_TYPE;\n(function (MEDIA_TYPE) {\n    MEDIA_TYPE[\"IFRAME\"] = \"IFRAME\";\n    MEDIA_TYPE[\"VIDEO\"] = \"VIDEO\";\n    MEDIA_TYPE[\"AUDIO\"] = \"AUDIO\";\n})(MEDIA_TYPE || (MEDIA_TYPE = {}));\nvar EVENT_TYPE;\n(function (EVENT_TYPE) {\n    EVENT_TYPE[\"PLAY\"] = \"Play\";\n    EVENT_TYPE[\"ENDED\"] = \"Ended\";\n    EVENT_TYPE[\"PAUSE\"] = \"Pause\";\n    EVENT_TYPE[\"TIME_WATCHED\"] = \"TimeWatched\";\n})(EVENT_TYPE || (EVENT_TYPE = {}));\nconst logger = new ConsoleLogger('MediaAutoTrack');\nconst startIframeAutoTracking = (element, recordEvent) => {\n    let isPlaying = false;\n    let player;\n    const mediaProperties = () => {\n        const duration = Number(parseFloat(player.getDuration()).toFixed(4));\n        const currentTime = Number(parseFloat(player.getCurrentTime()).toFixed(4));\n        return {\n            duration,\n            eventValue: Number((currentTime / duration).toFixed(4)),\n        };\n    };\n    const scriptElement = document.createElement('script');\n    scriptElement.type = 'text/javascript';\n    scriptElement.src = 'https://www.youtube.com/iframe_api';\n    document.body.append(scriptElement);\n    const timer = setInterval(() => {\n        if (isPlaying && player) {\n            recordEvent(EVENT_TYPE.TIME_WATCHED, mediaProperties());\n        }\n    }, 3000);\n    element.addEventListener('unload', () => clearInterval(timer));\n    // @ts-ignore\n    window.onYouTubeIframeAPIReady = () => {\n        // @ts-ignore\n        delete window.onYouTubeIframeAPIReady;\n        // @ts-ignore\n        player = new window.YT.Player(element.id, {\n            events: {\n                onStateChange: (event) => {\n                    const iframeEventMapping = {\n                        0: EVENT_TYPE.ENDED,\n                        1: EVENT_TYPE.PLAY,\n                        2: EVENT_TYPE.PAUSE,\n                    };\n                    // @ts-ignore\n                    const eventType = iframeEventMapping[event.data];\n                    switch (eventType) {\n                        case EVENT_TYPE.ENDED:\n                        case EVENT_TYPE.PAUSE:\n                            isPlaying = false;\n                            break;\n                        case EVENT_TYPE.PLAY:\n                            isPlaying = true;\n                            break;\n                    }\n                    if (eventType) {\n                        recordEvent(eventType, mediaProperties());\n                    }\n                },\n            },\n        });\n    };\n};\nconst startHTMLMediaAutoTracking = (element, recordEvent) => {\n    let isPlaying = false;\n    const mediaProperties = () => ({\n        duration: element.duration,\n        eventValue: Number((element.currentTime / element.duration).toFixed(4)),\n    });\n    const timer = setInterval(() => {\n        if (isPlaying) {\n            recordEvent(EVENT_TYPE.TIME_WATCHED, mediaProperties());\n        }\n    }, 3000);\n    element.addEventListener('unload', () => clearInterval(timer));\n    element.addEventListener(HTML5_MEDIA_EVENT.PLAY, () => {\n        isPlaying = true;\n        recordEvent(EVENT_TYPE.PLAY, mediaProperties());\n    });\n    element.addEventListener(HTML5_MEDIA_EVENT.PAUSE, () => {\n        isPlaying = false;\n        recordEvent(EVENT_TYPE.PAUSE, mediaProperties());\n    });\n    element.addEventListener(HTML5_MEDIA_EVENT.ENDED, () => {\n        isPlaying = false;\n        recordEvent(EVENT_TYPE.ENDED, mediaProperties());\n    });\n};\nconst checkElementLoaded = (interval, maxTries) => {\n    let retryCount = 0;\n    const wait = () => new Promise(r => setTimeout(r, interval));\n    const check = async (elementId) => {\n        if (retryCount >= maxTries) {\n            return false;\n        }\n        const domElement = document.getElementById(elementId);\n        if (domElement && domElement.clientHeight) {\n            return true;\n        }\n        else {\n            retryCount += 1;\n            await wait();\n            return await check(elementId);\n        }\n    };\n    return check;\n};\nconst recordEvent = (config, eventBuffer) => (eventType, properties) => {\n    // override eventType and merge properties\n    eventBuffer.append({\n        ...config,\n        event: {\n            ...config.event,\n            eventType,\n            properties: {\n                ...config.event.properties,\n                ...properties,\n            },\n        },\n        timestamp: Date.now(),\n    });\n};\nexport const autoTrackMedia = async (config, eventBuffer) => {\n    const { eventType, properties } = config.event;\n    const { domElementId, ...otherProperties } = properties;\n    if (!isBrowser()) {\n        logger.debug(`${eventType} only for browser`);\n        return;\n    }\n    if (typeof domElementId === 'string' && !domElementId) {\n        logger.debug(\"Missing domElementId field in 'properties' for MediaAutoTrack event type.\");\n        return;\n    }\n    const elementId = domElementId;\n    const isElementLoaded = await checkElementLoaded(500, 5)(elementId);\n    if (isElementLoaded) {\n        const autoTrackConfigWithoutDomElementId = {\n            ...config,\n            event: {\n                ...config.event,\n                properties: otherProperties,\n            },\n        };\n        const element = document.getElementById(elementId);\n        switch (element?.tagName) {\n            case MEDIA_TYPE.IFRAME:\n                startIframeAutoTracking(element, recordEvent(autoTrackConfigWithoutDomElementId, eventBuffer));\n                break;\n            case MEDIA_TYPE.VIDEO:\n            case MEDIA_TYPE.AUDIO:\n                if (element instanceof HTMLMediaElement) {\n                    startHTMLMediaAutoTracking(element, recordEvent(autoTrackConfigWithoutDomElementId, eventBuffer));\n                }\n                break;\n            default:\n                logger.debug(`Unsupported DOM element tag: ${element?.tagName}`);\n                break;\n        }\n    }\n    else {\n        logger.debug('Cannot find the media element.');\n    }\n};\n"],"names":[],"mappings":"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"}